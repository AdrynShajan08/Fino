{% extends "layout.html" %}
{% block content %}
<div class="container" style="max-width:800px;margin:auto;">
  <h2 style="text-align:center;">üí∞ Add Expense</h2>

  <form id="expenseForm" style="margin-top:20px;">
    <label>Category:</label><br>
    <select name="category" id="category" style="width:100%;padding:8px;margin-bottom:15px;" required>
      <option value="utilities">Utilities</option>
      <option value="rent">Rent</option>
      <option value="dining">Dining</option>
      <option value="turf">Turf</option>
      <option value="entertainment">Entertainment</option>
      <option value="charity">Charity</option>
      <option value="groceries">Groceries</option>
      <option value="shopping">Shopping</option>
      <option value="other">Other</option>
    </select><br>

    <label>Amount (‚Çπ):</label><br>
    <input type="number" name="amount" id="amount" step="0.01" min="0" required><br><br>

    <label>Date:</label><br>
    <input type="date" name="date" id="date" required><br><br>

    <label>Description:</label><br>
    <input type="text" name="description" id="description" placeholder="Optional"><br><br>

    <button type="submit" class="btn btn-primary">üíæ Add Expense</button>
  </form>

  <p id="status" style="text-align:center;margin-top:10px;color:green;"></p>

  <!-- Filters -->
  <div style="margin-top:30px;text-align:center;">
    <label>Filter by: </label>
    <select id="filterMonth" style="padding:5px;">
      <option value="">All Months</option>
      <option value="01">January</option>
      <option value="02">February</option>
      <option value="03">March</option>
      <option value="04">April</option>
      <option value="05">May</option>
      <option value="06">June</option>
      <option value="07">July</option>
      <option value="08">August</option>
      <option value="09">September</option>
      <option value="10">October</option>
      <option value="11">November</option>
      <option value="12">December</option>
    </select>
    <select id="filterYear" style="padding:5px;">
      <option value="">All Years</option>
    </select>
    <button onclick="applyFilters()" class="btn btn-sm btn-secondary">Apply</button>
  </div>

  <h3 style="text-align:center;margin-top:40px;">Your Expenses</h3>
  <table class="table table-striped table-hover" style="margin:auto;margin-top:10px;width:100%;">
    <thead class="table-dark">
      <tr>
        <th>Category</th>
        <th>Amount (‚Çπ)</th>
        <th>Date</th>
        <th>Description</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="expenseTable">
      <tr><td colspan="5" class="text-center">Loading...</td></tr>
    </tbody>
  </table>

  <!-- Edit Modal -->
  <div id="editModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:9999;">
    <div style="background:white;padding:20px;border-radius:8px;width:400px;max-width:90%;">
      <h3>Edit Expense</h3>
      <form id="editForm">
        <input type="hidden" name="id" id="editId">
        
        <label>Category:</label><br>
        <select name="category" id="editCategory" class="form-control mb-2" required>
          <option value="utilities">Utilities</option>
          <option value="rent">Rent</option>
          <option value="dining">Dining</option>
          <option value="turf">Turf</option>
          <option value="entertainment">Entertainment</option>
          <option value="charity">Charity</option>
          <option value="groceries">Groceries</option>
          <option value="shopping">Shopping</option>
          <option value="other">Other</option>
        </select>
        
        <label>Amount (‚Çπ):</label><br>
        <input type="number" name="amount" id="editAmount" class="form-control mb-2" step="0.01" min="0" required><br>
        
        <label>Date:</label><br>
        <input type="date" name="date" id="editDate" class="form-control mb-2" required><br>
        
        <label>Description:</label><br>
        <input type="text" name="description" id="editDescription" class="form-control mb-3"><br>
        
        <button type="submit" class="btn btn-primary">üíæ Update</button>
        <button type="button" onclick="closeModal()" class="btn btn-secondary">‚ùå Cancel</button>
      </form>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/voice_input.js') }}"></script>
<script>
// Set today's date as default
document.getElementById('date').valueAsDate = new Date();

// Populate year filter
const yearSelect = document.getElementById('filterYear');
const currentYear = new Date().getFullYear();
for (let year = currentYear; year >= currentYear - 5; year--) {
  const option = document.createElement('option');
  option.value = year;
  option.textContent = year;
  yearSelect.appendChild(option);
}

/**
 * Load expenses from server
 */
async function loadExpenses(month = '', year = '') {
  try {
    let url = '/get_expenses_full';
    const params = new URLSearchParams();
    if (month) params.append('month', month);
    if (year) params.append('year', year);
    if (params.toString()) url += '?' + params.toString();
    
    const data = await ApiClient.get(url);
    
    const table = document.getElementById('expenseTable');
    table.innerHTML = '';
    
    if (data.length === 0) {
      table.innerHTML = '<tr><td colspan="5" class="text-center">No expenses found</td></tr>';
      return;
    }
    
    data.forEach(item => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${item.category}</td>
        <td>${formatCurrency(item.amount)}</td>
        <td>${item.date}</td>
        <td>${item.description || '-'}</td>
        <td>
          <button onclick="openEdit(${item.id}, '${item.category}', ${item.amount}, '${item.date}', '${escapeHtml(item.description)}')" 
                  class="btn btn-sm btn-warning">‚úèÔ∏è</button>
          <button onclick="deleteExpense(${item.id})" 
                  class="btn btn-sm btn-danger">üóëÔ∏è</button>
        </td>
      `;
      table.appendChild(row);
    });
  } catch (error) {
    console.error('Failed to load expenses:', error);
    document.getElementById('expenseTable').innerHTML = 
      '<tr><td colspan="5" class="text-center text-danger">Failed to load expenses</td></tr>';
  }
}

/**
 * Apply filters
 */
function applyFilters() {
  const month = document.getElementById('filterMonth').value;
  const year = document.getElementById('filterYear').value;
  loadExpenses(month, year);
}

/**
 * Add expense
 */
async function addExpense(e) {
  e.preventDefault();
  
  if (!validateForm(e.target)) return;
  
  try {
    const formData = new FormData(e.target);
    const data = formDataToObject(formData);
    
    const response = await ApiClient.post('/add_expense', data);
    
    showToast(response.message, 'success');
    e.target.reset();
    document.getElementById('date').valueAsDate = new Date();
    
    loadExpenses();
    broadcastUpdate('expense');
  } catch (error) {
    console.error('Failed to add expense:', error);
  }
}

/**
 * Delete expense
 */
async function deleteExpense(id) {
  if (!await confirmAction('Are you sure you want to delete this expense?')) return;
  
  try {
    const response = await ApiClient.delete(`/delete_expense/${id}`);
    showToast(response.message, 'success');
    loadExpenses();
    broadcastUpdate('expense');
  } catch (error) {
    console.error('Failed to delete expense:', error);
  }
}

/**
 * Open edit modal
 */
function openEdit(id, category, amount, date, description) {
  document.getElementById('editModal').style.display = 'flex';
  document.getElementById('editId').value = id;
  document.getElementById('editCategory').value = category;
  document.getElementById('editAmount').value = amount;
  document.getElementById('editDate').value = date;
  document.getElementById('editDescription').value = unescapeHtml(description);
}

/**
 * Close edit modal
 */
function closeModal() {
  document.getElementById('editModal').style.display = 'none';
}

/**
 * Update expense
 */
async function updateExpense(e) {
  e.preventDefault();
  
  if (!validateForm(e.target)) return;
  
  try {
    const formData = new FormData(e.target);
    const data = formDataToObject(formData);
    const id = data.id;
    delete data.id;
    
    const response = await ApiClient.post(`/update_expense/${id}`, data);
    showToast(response.message, 'success');
    
    closeModal();
    loadExpenses();
    broadcastUpdate('expense');
  } catch (error) {
    console.error('Failed to update expense:', error);
  }
}

/**
 * Escape HTML to prevent XSS
 */
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/**
 * Unescape HTML
 */
function unescapeHtml(html) {
  if (!html) return '';
  const div = document.createElement('div');
  div.innerHTML = html;
  return div.textContent;
}

// Event listeners
document.getElementById('expenseForm').addEventListener('submit', addExpense);
document.getElementById('editForm').addEventListener('submit', updateExpense);

// Listen for updates from other tabs
onUpdate((data) => {
  if (data.type === 'expense' || data.type === 'general') {
    loadExpenses();
  }
});

// Initial load
loadExpenses();
</script>
{% endblock %}