{% extends "layout.html" %}
{% block content %}
<div class="container" style="max-width:1000px;margin:auto;">
  <h2 style="text-align:center;">ğŸ’° Personal Finance Dashboard</h2>
<div style="text-align:center;margin-top:20px;">
  <label>Month:</label>
  <select id="monthSelect">
    <option value="">All</option>
    {% for m in range(1, 13) %}
    <option value="{{'%02d' % m}}">{{'%02d' % m}}</option>
    {% endfor %}
  </select>
  <label>Year:</label>
  <select id="yearSelect"></select>
  <button onclick="applyFilters()">ğŸ” Apply Filters</button>
</div>

  <!-- SPENDS -->
  <section id="expenses-section" style="margin-top:30px;">
    <h3>ğŸ“Š Monthly Spend Summary</h3>
    <h4 id="totalSpend">Total Spent: â‚¹0</h4>
    <canvas id="spendChart" style="max-width:600px;margin-top:20px;"></canvas>
    <h4 style="margin-top:40px;">ğŸ“ˆ Investment Growth Over Time</h4>
    <canvas id="investTrendChart" style="max-width:800px;margin-top:20px;"></canvas>
    <table border="1" cellpadding="8" style="margin-top:20px;width:80%;text-align:center;">
      <thead>
        <tr>
          <th>Category</th>
          <th>Total (â‚¹)</th>
        </tr>
      </thead>
      <tbody id="summaryTable">
        <tr><td colspan="2">Loading...</td></tr>
      </tbody>
    </table>
  </section>

  <hr style="margin:40px 0;">

  <!-- INVESTMENTS -->
  <section id="investments-section">
    <h3>ğŸ’¹ Investment Tracker</h3>

    <form id="investmentForm" style="margin-top:10px;">
      <label>Asset Type:</label>
      <input type="text" name="asset" placeholder="e.g., Stocks, FD" required>
      <label>Value (â‚¹):</label>
      <input type="number" name="value" step="0.01" required>
      <label>Date:</label>
      <input type="date" name="date">
      <button type="submit">ğŸ’¾ Add</button>
    </form>

    <p id="status" style="color:green;margin-top:10px;"></p>

    <h4 style="margin-top:30px;">Your Investments</h4>
    <canvas id="investChart" style="max-width:600px;margin-top:20px;"></canvas>

    <table border="1" cellpadding="8" style="margin-top:20px;width:90%;text-align:center;">
      <thead>
        <tr>
          <th>Asset</th>
          <th>Value (â‚¹)</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="investmentTable">
        <tr><td colspan="4">Loading...</td></tr>
      </tbody>
    </table>
  </section>

<!-- Edit Investment Modal -->
<div id="editModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
     background:rgba(0,0,0,0.6);align-items:center;justify-content:center;">
  <div style="background:white;padding:20px;border-radius:8px;width:300px;">
    <h3>Edit Investment</h3>
    <form id="editForm">
      <input type="hidden" name="id">
      <label>Asset:</label><br>
      <input type="text" name="asset" required><br><br>
      <label>Value (â‚¹):</label><br>
      <input type="number" name="value" step="0.01" required><br><br>
      <label>Date:</label><br>
      <input type="date" name="date"><br><br>
      <button type="submit">ğŸ’¾ Update</button>
      <button type="button" onclick="closeModal()">âŒ Cancel</button>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let spendChart, investChart, investTrendChart;
let currentMonth = "", currentYear = "";

// Populating year dropdown dynamically
const currentYearNum = new Date().getFullYear();
const yearSelect = document.getElementById("yearSelect");
for (let y = currentYearNum; y >= currentYearNum - 5; y--) {
  const opt = document.createElement("option");
  opt.value = y;
  opt.text = y;
  yearSelect.add(opt);
}

//loading summary and investments with filters //
async function loadSummary() {
  const res = await fetch(`/get_summary?month=${currentMonth}&year=${currentYear}`);
  const data = await res.json();
  const labels = data.map(i => i.category);
  const values = data.map(i => i.total);
  const total = values.reduce((a, b) => a + b, 0);

  document.getElementById('totalSpend').innerText = `Total Spent: â‚¹${total.toFixed(2)}`;
  const table = document.getElementById('summaryTable');
  table.innerHTML = '';
  data.forEach(row => {
    table.innerHTML += `<tr><td>${row.category}</td><td>${row.total.toFixed(2)}</td></tr>`;
  });

  if (spendChart) spendChart.destroy();
  const ctx = document.getElementById('spendChart');
  spendChart = new Chart(ctx, {
    type: 'pie',
    data: { labels, datasets: [{ data: values }] },
    options: { plugins: { legend: { position: 'bottom' } } }
  });
}

async function loadInvestments() {
  const res = await fetch(`/get_investments_full?month=${currentMonth}&year=${currentYear}`);
  const data = await res.json();

  const table = document.getElementById('investmentTable');
  table.innerHTML = '';
  data.forEach(item => {
    table.innerHTML += `
      <tr>
        <td>${item.asset}</td>
        <td>${item.value.toFixed(2)}</td>
        <td>${item.date}</td>
        <td>
          <button onclick="openEdit(${item.id}, '${item.asset}', ${item.value}, '${item.date}')">âœï¸</button>
          <button onclick="deleteInvestment(${item.id})">ğŸ—‘ï¸</button>
        </td>
      </tr>`;
  });

  // Assets pie chart
  const byAsset = {};
  data.forEach(i => byAsset[i.asset] = (byAsset[i.asset] || 0) + i.value);
  const labels = Object.keys(byAsset);
  const values = Object.values(byAsset);

  if (investChart) investChart.destroy();
  investChart = new Chart(document.getElementById('investChart'), {
    type: 'pie',
    data: { labels, datasets: [{ data: values }] },
    options: { plugins: { legend: { position: 'bottom' } } }
  });

  // Investments trend chart
  const byDate = {};
  data.forEach(i => byDate[i.date] = (byDate[i.date] || 0) + i.value);
  const trendLabels = Object.keys(byDate).sort();
  const trendValues = trendLabels.map(d => byDate[d]);

  if (investTrendChart) investTrendChart.destroy();
  investTrendChart = new Chart(document.getElementById('investTrendChart'), {
    type: 'line',
    data: {
      labels: trendLabels,
      datasets: [{
        label: "Investment Value Over Time (â‚¹)",
        data: trendValues,
        fill: false,
        tension: 0.3
      }]
    },
    options: { plugins: { legend: { position: 'bottom' } } }
  });
}

function applyFilters() {
  currentMonth = document.getElementById("monthSelect").value;
  currentYear = document.getElementById("yearSelect").value;
  loadSummary();
  loadInvestments();
}

async function addInvestment(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData.entries());

  const res = await fetch("/add_investment", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });

  const json = await res.json();
  document.getElementById("status").innerText = json.message;
  e.target.reset();
  loadInvestments();
  broadcastUpdate();
}

async function deleteInvestment(id) {
  if (!confirm("Delete this investment?")) return;
  const res = await fetch(`/delete_investment/${id}`, { method: "DELETE" });
  const data = await res.json();
  alert(data.message);
  loadInvestments();
  broadcastUpdate();
}

function openEdit(id, asset, value, date) {
  document.getElementById('editModal').style.display = 'flex';
  const form = document.getElementById('editForm');
  form.id.value = id;
  form.asset.value = asset;
  form.value.value = value;
  form.date.value = date;
}

function closeModal() {
  document.getElementById('editModal').style.display = 'none';
}

document.getElementById("editForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData.entries());

  const res = await fetch(`/update_investment/${data.id}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
  const json = await res.json();
  alert(json.message);
  closeModal();
  loadInvestments();
  broadcastUpdate();
});

// live synchronization
const channel = new BroadcastChannel("finance_updates");
function broadcastUpdate() {
  channel.postMessage("data_updated");
}
channel.onmessage = (event) => {
  if (event.data === "data_updated") {
    loadSummary();
    loadInvestments();
  }
};

document.getElementById("investmentForm").addEventListener("submit", addInvestment);
loadSummary();
loadInvestments();
</script>
{% endblock %}
