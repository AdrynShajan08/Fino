{% extends "layout.html" %}
{% block content %}
<div class="container" style="max-width:800px;margin:auto;">
  <h2 style="text-align:center;">💹 Investment Tracker</h2>

  <form id="investmentForm" style="margin-top:20px;">
    <label>Asset Type:</label><br>
    <input type="text" name="asset" id="asset" class="form-control mb-2" placeholder="e.g., Stocks, Mutual Fund" required><br>

    <label>Value (₹):</label><br>
    <input type="number" name="value" id="value" class="form-control mb-2" step="0.01" min="0" required><br>

    <label>Date:</label><br>
    <input type="date" name="date" id="date" class="form-control mb-3" required><br>

    <button type="submit" class="btn btn-primary">💾 Save Investment</button>
  </form>

  <p id="status" style="text-align:center;margin-top:10px;color:green;"></p>

  <!-- Filters -->
  <div style="margin-top:30px;text-align:center;">
    <label>Filter by: </label>
    <select id="filterMonth" style="padding:5px;">
      <option value="">All Months</option>
      <option value="01">January</option>
      <option value="02">February</option>
      <option value="03">March</option>
      <option value="04">April</option>
      <option value="05">May</option>
      <option value="06">June</option>
      <option value="07">July</option>
      <option value="08">August</option>
      <option value="09">September</option>
      <option value="10">October</option>
      <option value="11">November</option>
      <option value="12">December</option>
    </select>
    <select id="filterYear" style="padding:5px;">
      <option value="">All Years</option>
    </select>
    <button onclick="applyFilters()" class="btn btn-sm btn-secondary">Apply</button>
  </div>

  <h3 style="text-align:center;margin-top:40px;">Your Investments</h3>
  <table class="table table-striped table-hover" style="margin:auto;margin-top:10px;width:100%;">
    <thead class="table-dark">
      <tr>
        <th>Asset</th>
        <th>Value (₹)</th>
        <th>Date</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="investmentTable">
      <tr><td colspan="4" class="text-center">Loading...</td></tr>
    </tbody>
  </table>

  <!-- Edit Modal -->
  <div id="editModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:9999;">
    <div style="background:white;padding:20px;border-radius:8px;width:400px;max-width:90%;">
      <h3>Edit Investment</h3>
      <form id="editForm">
        <input type="hidden" name="id" id="editId">
        
        <label>Asset:</label><br>
        <input type="text" name="asset" id="editAsset" class="form-control mb-2" required><br>
        
        <label>Value (₹):</label><br>
        <input type="number" name="value" id="editValue" class="form-control mb-2" step="0.01" min="0" required><br>
        
        <label>Date:</label><br>
        <input type="date" name="date" id="editDate" class="form-control mb-3" required><br>
        
        <button type="submit" class="btn btn-primary">💾 Update</button>
        <button type="button" onclick="closeModal()" class="btn btn-secondary">❌ Cancel</button>
      </form>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/utils.js') }}"></script>
<script>
// Set today's date as default
document.getElementById('date').valueAsDate = new Date();

// Populate year filter
const yearSelect = document.getElementById('filterYear');
const currentYear = new Date().getFullYear();
for (let year = currentYear; year >= currentYear - 5; year--) {
  const option = document.createElement('option');
  option.value = year;
  option.textContent = year;
  yearSelect.appendChild(option);
}

/**
 * Load investments from server
 */
async function loadInvestments(month = '', year = '') {
  try {
    let url = '/get_investments_full';
    const params = new URLSearchParams();
    if (month) params.append('month', month);
    if (year) params.append('year', year);
    if (params.toString()) url += '?' + params.toString();
    
    const data = await ApiClient.get(url);
    
    const table = document.getElementById('investmentTable');
    table.innerHTML = '';
    
    if (data.length === 0) {
      table.innerHTML = '<tr><td colspan="4" class="text-center">No investments found</td></tr>';
      return;
    }
    
    data.forEach(item => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${escapeHtml(item.asset)}</td>
        <td>${formatCurrency(item.value)}</td>
        <td>${item.date}</td>
        <td>
          <button onclick="openEdit(${item.id}, '${escapeHtml(item.asset)}', ${item.value}, '${item.date}')" 
                  class="btn btn-sm btn-warning">✏️</button>
          <button onclick="deleteInvestment(${item.id})" 
                  class="btn btn-sm btn-danger">🗑️</button>
        </td>
      `;
      table.appendChild(row);
    });
  } catch (error) {
    console.error('Failed to load investments:', error);
    document.getElementById('investmentTable').innerHTML = 
      '<tr><td colspan="4" class="text-center text-danger">Failed to load investments</td></tr>';
  }
}

/**
 * Apply filters
 */
function applyFilters() {
  const month = document.getElementById('filterMonth').value;
  const year = document.getElementById('filterYear').value;
  loadInvestments(month, year);
}

/**
 * Add investment
 */
async function addInvestment(e) {
  e.preventDefault();
  
  if (!validateForm(e.target)) return;
  
  try {
    const formData = new FormData(e.target);
    const data = formDataToObject(formData);
    
    const response = await ApiClient.post('/add_investment', data);
    
    showToast(response.message, 'success');
    e.target.reset();
    document.getElementById('date').valueAsDate = new Date();
    
    loadInvestments();
    broadcastUpdate('investment');
  } catch (error) {
    console.error('Failed to add investment:', error);
  }
}

/**
 * Delete investment
 */
async function deleteInvestment(id) {
  if (!await confirmAction('Are you sure you want to delete this investment?')) return;
  
  try {
    const response = await ApiClient.delete(`/delete_investment/${id}`);
    showToast(response.message, 'success');
    loadInvestments();
    broadcastUpdate('investment');
  } catch (error) {
    console.error('Failed to delete investment:', error);
  }
}

/**
 * Open edit modal
 */
function openEdit(id, asset, value, date) {
  document.getElementById('editModal').style.display = 'flex';
  document.getElementById('editId').value = id;
  document.getElementById('editAsset').value = unescapeHtml(asset);
  document.getElementById('editValue').value = value;
  document.getElementById('editDate').value = date;
}

/**
 * Close edit modal
 */
function closeModal() {
  document.getElementById('editModal').style.display = 'none';
}

/**
 * Update investment
 */
async function updateInvestment(e) {
  e.preventDefault();
  
  if (!validateForm(e.target)) return;
  
  try {
    const formData = new FormData(e.target);
    const data = formDataToObject(formData);
    const id = data.id;
    delete data.id;
    
    const response = await ApiClient.post(`/update_investment/${id}`, data);
    showToast(response.message, 'success');
    
    closeModal();
    loadInvestments();
    broadcastUpdate('investment');
  } catch (error) {
    console.error('Failed to update investment:', error);
  }
}

/**
 * Escape HTML to prevent XSS
 */
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/**
 * Unescape HTML
 */
function unescapeHtml(html) {
  if (!html) return '';
  const div = document.createElement('div');
  div.innerHTML = html;
  return div.textContent;
}

// Event listeners
document.getElementById('investmentForm').addEventListener('submit', addInvestment);
document.getElementById('editForm').addEventListener('submit', updateInvestment);

// Listen for updates from other tabs
onUpdate((data) => {
  if (data.type === 'investment' || data.type === 'general') {
    loadInvestments();
  }
});

// Initial load
loadInvestments();
</script>
{% endblock %}